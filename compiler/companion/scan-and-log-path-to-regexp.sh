#!/bin/bash

# âš”ï¸ ÙØ­Øµ Ø³ÙŠØ§Ø¯ÙŠ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ù…Ø¹ ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ù…Ù†ÙŠØ©

echo "ðŸ” Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª..."

vulnerable_version="0.1.7"

for repo in */; do
  repo=${repo%/}

  # ØªØ¬Ø§Ù‡Ù„ Ù…Ø¬Ù„Ø¯Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„ÙØ­Øµ
  if [[ "$repo" == "node_modules" || "$repo" == "test" || "$repo" == "lib" ]]; then
    continue
  fi

  # ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ package.json
  if [[ ! -f "$repo/package.json" ]]; then
    echo "âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ package.json ÙÙŠ $repo â€” ØªÙ… Ø§Ù„ØªØ¬Ø§Ù‡Ù„"
    echo "----------------------------------------"
    continue
  fi

  echo "ðŸ“ ÙØ­Øµ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: $repo"

  matches=$(grep -r "\"path-to-regexp\": \"$vulnerable_version\"" "$repo" 2>/dev/null)

  if [[ -z "$matches" ]]; then
    echo "âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ù…ØªØ£Ø«Ø±Ø© ÙÙŠ $repo"
  else
    echo "âŒ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ù…ØªØ£Ø«Ø±Ø© ÙÙŠ $repo"
    echo "$matches"

    audit_file="$repo/SECURITY-AUDIT.md"
    echo "ðŸ“ ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ±: $audit_file"

    cat > "$audit_file" <<EOF
# ðŸ”’ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ­Øµ Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ: path-to-regexp

**ðŸ“ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:** \`$repo\`  
**ðŸ“¦ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:** \`path-to-regexp@$vulnerable_version\`  
**ðŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ:** $(date '+%Y-%m-%d %H:%M:%S')  
**ðŸ›¡ï¸ Ø§Ù„Ø­Ø§Ù„Ø©:** âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ù…ØªØ£Ø«Ø±Ø©

## ðŸ” Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:

\`\`\`
$matches
\`\`\`

## âœ… Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠØ©:

- Ø§Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:
  \`package-lock.json\`, \`node_modules\`
- Ø£Ø¶Ù Ø¥Ù„Ù‰ \`package.json\`:

\`\`\`json
"overrides": {
  "path-to-regexp": "0.1.12"
}
\`\`\`

- Ø«Ù… Ù†ÙÙ‘Ø°:

\`\`\`bash
npm install
\`\`\`

## ðŸ§  Ù…Ù„Ø§Ø­Ø¸Ø©:

Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© ÙØ­Øµ Ø³ÙŠØ§Ø¯ÙŠ Ù„Ø­Ù…Ø§ÙŠØªÙƒ Ù…Ù† Ø«ØºØ±Ø© ReDoS ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.

EOF
  fi

  echo "----------------------------------------"
done

echo "ðŸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª."
